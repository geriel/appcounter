# grunt-vtex-deploy

> VTEX Deploy for front end projects

## Getting Started
This plugin requires Grunt `~0.4.1`

If you haven't used [Grunt](http://gruntjs.com/) before, be sure to check out the [Getting Started](http://gruntjs.com/getting-started) guide, as it explains how to create a [Gruntfile](http://gruntjs.com/sample-gruntfile) as well as install and use Grunt plugins. Once you're familiar with that process, you may install this plugin with this command:

```shell
npm install grunt-vtex-deploy --save-dev
```

Once the plugin has been installed, it may be enabled inside your Gruntfile with this line of JavaScript:

```js
grunt.loadNpmTasks('grunt-vtex-deploy');
```

## The "vtex_deploy" task

### Overview
In your project's Gruntfile, add a section named `vtex_deploy` to the data object passed into `grunt.initConfig()`.

```js
grunt.initConfig({
  vtex_deploy: {
    options: {
      // Task-specific options go here.
    },
    your_target: {
      // Target-specific file lists and/or options go here.
    },
  },
})
```

### Deployment build

    DEPLOY_ENV=beta GIT_COMMIT=`git rev-parse --verify HEAD` grunt deploy

Have a look at the newly created deploy/spdbg-01-00-00-1-stable/index.html file.


### Quick deploy explanation

- The first step is compiling your assets (coffee/LESS) to the `build` folder (`gen-commit` task).
- Then, tests are run, ensuring your app is OK (`karma-deploy` task).
- Thirdly, your app is copied to a commit folder.
This folder should have all variable tags in the form "&lt;%=@VARIABLE%&gt;".
Use the `string-replace:commit` task to replace anything else you need!
This folder serves as a cache on the build server - the same commit should never be built twice!
- Finally, a version folder is generated, replacing all variable tags for correct values (`gen-version` task).

### Interesting options

#### options.tempDirectory:
Default value: "./tmp-deploy/"

#### options.requireEnvironmentType:
Default value: process.env["ENVIRONMENT_TYPE"]  
If you need a target to only run in a given environment type (e.g., stable).

#### options.bucket:
Default value: "vtex-io"  
The bucket to which your files will be uploaded.

#### options.buildDirectory:
Default value: "build"  
The directory where your app's files can be found ready for deploy.

#### options.whoamiPath:
Default value: false  
Path to `whoami` file. You should point one if you need to be deployed inside a router container.

#### options.indexPath:
Default value: false  
Path to `index.html` file. You should point one if you need to be deployed inside a router container.

#### options.indexOnRoot:
Default value: false  
Wheter your index.html should also be uploaded to the root of your application's directory (e.g. `s3://bucket/yourapp/index.html`)

#### options.includeHostname:
Default value:

    src: true
    href: true
    versionDirectory: true
    hostname: null
    files: []
  
Conveniently replace special parts of your `files` with hostname and version directory.  
If `src` is `true`, will replace `src="myfile.js"` with `src="//HOSTNAME/myapp/v01-00-00-stable-1/myfile.js"`. Same for `href`.  
If versionDirectory is true, will replace the special `VERSION_DIRECTORY` variable with your app's directory name, e.g. `myapp/v01-00-00-stable-1/`. *Includes trailing slash*.

### Usage Examples

    vtex_deploy: {
      main: {
        options: {
          indexPath: 'build/index.html',
          whoamiPath: 'whoami',
          includeHostname: {
            hostname: 'io.vtex.com.br',
            files: ["build/index.html", "build/test1"]
          }
        }
      },
      walmart: {
        options: {
          buildDirectory: 'build-raw',
          bucket: 'vtex-io-walmart',
          requireEnvironmentType: 'stable',
          indexPath: 'build-raw/index.html',
          indexOnRoot: true,
          includeHostname: {
            hostname: 'VTEX_IO_HOST',
            files: ["build-raw/index.html", "build-raw/test1"]
          }
        }
      }
    }

## Contributing
In lieu of a formal styleguide, take care to maintain the existing coding style. Add unit tests for any new or changed functionality. Lint and test your code using [Grunt](http://gruntjs.com/).

## Release History
_(Nothing yet)_
